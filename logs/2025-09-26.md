# 作業記録 2025-09-26 (統合版)

---

# 技術検証：Python連携 (GraalVM)

## 達成事項

- Kotlin-Python連携の技術検証を実施し、主要なデータ型の相互受け渡しに成功。
- GraalVM Polyglot APIの重要な挙動を特定し、将来の参照用にテストコードを確立した。

## 検証プロセスと重要な知見

- **データ連携:** Kotlinの`List`や`Map`をPythonに渡す際は `Context.newBuilder().allowHostAccess(HostAccess.ALL).build()` を使用し、ホストアクセスを明示的に許可する必要があることを確認。
- **辞書アクセス:** Pythonの辞書をKotlin側で受け取る場合、`getMember()` ではなく `getHashValue("key")` を使ってキーにアクセスする必要があることを確認。
- **エラーハンドリング:** Python側で発生した構文エラー、実行時エラーが、Kotlin側で `PolyglotException` として正しくキャッチできることを確認。

---

# 技術検証：ExcelファイルI/O (Apache POI)

## 達成事項

- プロジェクトのコア機能であるExcelファイル(`.xlsx`)の読み書き機能に関する技術検証を完了した。
- `Apache POI`ライブラリがプロジェクト環境で正常に動作することを確認した。

---

# 技術検証：データベース連携 (Exposed ORM)

## 達成事項

- プロジェクトの「Access代替機能」の根幹をなす、データベース連携に関する技術検証を完了した。
- Kotlin製ORM `Exposed` とインメモリデータベース `H2` を用いて、基本的なDB操作が可能であることを確認した。

---

# 開発サイクル B->A->C

## B: セル参照の実装

### 1. 計算エンジンリファクタリング
- **達成事項:** セル参照機能の実装に向け、計算エンジンを「パーサー/評価器」モデルにリファクタリングした。
- **変更点:** `Expression` (AST)クラスの導入、`FormulaEvaluator` の新設、および `Cell`, `FormulaParser`, `Sheet` の関連クラスをすべて新しいアーキテクチャに適応させた。

### 2. 依存関係の追跡
- **達成事項:** セル間の依存関係を追跡するグラフ構造を実装した。
- **変更点:** `Sheet`クラスに依存関係を保持するマップを追加し、`updateCell`時にそれらが正しく更新されるようにロジックを組んだ。

### 3. 再計算と循環参照
- **達成事項:** 自動再計算と循環参照の検出機能を実装し、スプレッドシートの動的なコアエンジンを完成させた。
- **変更点:** `Sheet`クラスに循環参照を検出するロジックと、依存グラフをたどって再帰的にセルを再計算するロジックを実装した。

## A: 数式パーサーの強化

- **達成事項:** 数式パーサーを強化し、四則演算、計算の優先順位、括弧を正しく扱えるようにした。
- **変更点:** `FormulaParser` に再帰下降法アルゴリズムを導入し、`FormulaEvaluator` に四則演算のロジックを追加。括弧に対応するためのロジックも実装した。

## C: UIとデータモデルの連携

- **達成事項:** 作成してきた内部データモデル（`Sheet`クラス）とUI（`SpreadsheetView`）を連携させた。
- **変更点:** `main`関数で`Sheet`オブジェクトを生成・初期化し、UIコンポーネントに渡すように変更。UI側は受け取った`Sheet`の値を表示するようにした。

---

# 組み込み関数の実装（フェーズ1）

## 達成事項

- 基本的な集計関数（`SUM`, `AVERAGE`, `COUNT`, `MAX`, `MIN`）と、その前提機能であるセル範囲 (`A1:B10`) の処理を実装した。

## 検証内容

- **パーサーとASTの拡張:** `FunctionCall`と`CellRange`のASTノードを追加し、パーサーが関数呼び出しとセル範囲の構文を解釈できるようにした。
- **評価器と関数ロジックの実装:** `Functions.kt`を新設して具体的な計算ロジックを実装し、`FormulaEvaluator`がそれらを呼び出すように拡張した。
- **テストによる検証:** `SUM(A1:C1)`のような範囲計算や、未知の関数に対する`#NAME?`エラーなどが正しく処理されることを確認した。

---

# パーサー強化：比較・論理値

## 達成事項

- 論理関数 `IF` の実装に向けた前提作業として、数式パーサーをさらに拡張し、比較演算子（`>` や `<`など）と、真偽値リテラル（`TRUE`, `FALSE`）を解釈できるようにした。

## 検証内容

### 1. ASTとパーサーの拡張

- `Expression.kt` の `Operator` enum に、`GREATER_THAN`, `EQUAL` などの比較演算子を追加。
- `Expression.kt` に `BooleanLiteral` データクラスを追加。
- `FormulaParser.kt` の解析ロジックに、`+` `-` よりも低い優先順位として比較演算子の階層を追加。`TRUE` や `FALSE` という文字列を `BooleanLiteral` として認識するよう `parseIdentifier` メソッドを修正した。

### 2. 評価器の拡張

- `FormulaEvaluator.kt` に、比較演算の結果として `CellValue.BooleanValue` を返すロジックを追加。また、`BooleanLiteral` を評価できるようにした。

### 3. テストによる検証

- `FormulaParserTest` に、`=A1+B1>C1` のような、演算子の優先順位が正しく解釈されることを確認するテストを追加。
- `SheetTest` に、`=10>5` のような比較式の計算結果が、正しく `true` になることを確認するテストを追加。
- テストコードのバグを修正し、すべてのテストが成功することを確認した。

## 次の作業

- `IF`関数の短絡評価を実現するため、評価器をリファクタリングし、論理関数（`IF`, `AND`, `OR`, `NOT`）を実装する。

---

# 組み込み関数の実装：論理関数

## 達成事項

- 組み込み関数の第二弾として、論理関数（`IF`, `AND`, `OR`, `NOT`）の実装を完了した。
- `IF`関数の「短絡評価」を実現するため、評価器のアーキテクチャをリファクタリングした。

## 検証内容

### 1. パーサーとASTの拡張（前提作業）

- `IF`関数の条件式（例: `A1>10`）を実装するため、パーサーが比較演算子（`>`, `<`, `=`など）と真偽値リテラル（`TRUE`, `FALSE`）を解釈できるよう、ASTとパーサーのロジックを拡張した。

### 2. 評価器のリファクタリング（スペシャルフォーム）

- `IF`や`AND`のように、引数を通常とは異なる方法で評価する必要がある関数を「スペシャルフォーム」として定義。
- `FormulaEvaluator`が関数名に応じてスペシャルフォーム用の評価ロジックを呼び出すようにアーキテクチャを修正した。
- `IF`関数の場合、第一引数（条件式）の結果に基づき、第二または第三引数のどちらか一方のASTのみを評価する「短絡評価」を実装した。

### 3. 論理関数の実装

- `IF`, `AND`, `OR` をスペシャルフォームとして実装。
- `NOT` を通常の関数として実装。

### 4. テストによる検証

- `SheetTest`に、`IF`, `AND`, `OR`, `NOT`が正しく動作することを確認するテストを追加。
- 特に、`=IF(TRUE, 10, 1/0)` のような数式が、`1/0` の部分を評価せずに正しく `10` を返す「短絡評価」が機能していることを重点的に検証し、成功を確認した。

## 次の作業

- 引き続き、他のカテゴリの組み込み関数（文字列関数 `CONCATENATE` など）の実装に進む。

---

# 組み込み関数の実装：テキスト関数

## 達成事項

- 組み込み関数の第三弾として、テキスト関数（`CONCATENATE`, `LEFT`, `RIGHT`, `LEN`）の実装を完了した。
- 上記関数の前提機能として、数式内での文字列リテラル（ダブルクォーテーションで囲まれた文字列）の解析に対応した。

## 検証内容

### 1. パーサーとASTの拡張（文字列リテラル）

- `Expression.kt` に `StringLiteral` のASTノードを追加。
- `FormulaParser.kt` の `parseFactor` メソッドに、`"` で囲まれた部分を `StringLiteral` として解釈するロジックを追加した。
- `FormulaEvaluator.kt` と `Sheet.kt` の `when` 式を更新し、`StringLiteral` に対応させた。

### 2. テキスト関数の実装

- `Functions.kt` に、`CONCATENATE`, `LEFT`, `RIGHT`, `LEN` の具体的な計算ロジックを実装し、`builtinFunctions` マップに登録した。

### 3. テストによる検証

- `SheetTest` に、`=CONCATENATE("Hello", " ", "World")` のような文字列リテラルを含む数式や、`=LEFT(A1, 5)` のようなテキスト操作が正しく計算されることを確認するテストを追加。
- 当初発生したバグ（文字列リテラルがパースできない）を修正し、すべてのテストが成功することを確認した。

## 次の作業

- 引き続き、他のカテゴリの組み込み関数（ルックアップ関数 `VLOOKUP` など）の実装に進む。

---

# 組み込み関数の実装：ルックアップ関数（フェーズ4 - 完全一致）

## 達成事項

- 組み込み関数の第四弾として、Excelで最も重要とされる関数の一つである `VLOOKUP` の実装を完了した。（※現時点では完全一致検索のみ）

## 検証内容

### 1. `VLOOKUP` のスペシャルフォームとしての実装

- `VLOOKUP`は、第二引数のテーブル範囲の構造（行・列）を維持したまま解釈する必要があるため、`IF`関数と同様に「スペシャルフォーム」として実装した。
- `Functions.kt` に `vlookup` のロジックを追加。引数の数や型を検証し、第二引数が `CellRange` であることを確認する処理を実装した。
- 指定された範囲の最初の列を線形探索し、検索値と完全に一致する行を見つけ、指定された列番号の値を返すロジックを実装した。

### 2. テストによる検証

- `SheetTest.kt` に、`VLOOKUP` の動作を検証するテストケースを追加。
  - 正しく値を取得できること（Happy Path）。
  - 検索値が見つからなかった場合に `#N/A` エラーが返されること。
  - 指定した列番号が範囲外の場合に `#REF!` エラーが返されること。
- すべてのテストが成功し、`VLOOKUP` の基本的な動作の信頼性を確認した。

## 次の作業

- `VLOOKUP` の近似一致検索の実装。
- `HLOOKUP` の実装。
- 他のカテゴリの組み込み関数（UI/UX関連など）の実装。

---

# 組み込み関数の実装：ルックアップ関数（フェーズ4 - 近似一致とHLOOKUP）

## 達成事項

- 組み込み関数の第四弾として、`VLOOKUP` の近似一致検索と `HLOOKUP`（完全一致、近似一致）の実装を完了した。

## 検証内容

### 1. `VLOOKUP` の近似一致実装

- `vlookup` 関数に、`range_lookup` が `TRUE` の場合の近似一致検索ロジックを追加。
- 検索範囲の最初の列が昇順にソートされていることを前提とし、検索値以下の最大の値を見つけて対応する行の値を返すようにした。

### 2. `HLOOKUP` の実装

- `HLOOKUP` を `specialFunctions` マップに登録し、`hlookup` 関数を実装。
- `vlookup` と同様のロジックで、行と列の処理を入れ替えることで水平方向の検索に対応した。

### 3. テストによる検証

- `SheetTest.kt` に、`VLOOKUP` の近似一致と `HLOOKUP` の全機能（完全一致、近似一致、エラーケース）を検証するテストを追加。
- すべてのテストが成功し、ルックアップ関数の信頼性を確認した。

## 次の作業

- `TODO.md` に基づき、次の開発タスクに進む。
